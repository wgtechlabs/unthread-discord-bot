---
name: Build

on:
  workflow_run:
    workflows: ["Test"]
    types:
      - completed
    branches: [dev]
  pull_request:
    branches: [dev, main]
    paths:
      - 'src/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - '.npmrc'
      - 'tsconfig.json'
      - 'vitest.config.ts'
      - 'Dockerfile'
      - '.github/workflows/build.yml'

jobs:
  build:
    name: Build Container Images
    runs-on: ubuntu-latest
    # Only run if tests passed (for workflow_run) or on PR (tests run in parallel)
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    permissions:
      contents: read
      packages: write
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Build and Push Container
        uses: wgtechlabs/container-build-flow-action@v1.1.0
        with:
          # Registry Configuration
          registry: both
          dockerhub-username: ${{ secrets.DOCKER_HUB_USERNAME }}
          dockerhub-token: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
          
          # Branch Configuration
          main-branch: main
          dev-branch: dev
          
          # Image Configuration
          image-name: unthread-discord-bot
          dockerfile: ./Dockerfile
          context: .
          platforms: linux/amd64
          
          # Build Arguments
          build-args: |
            NODE_VERSION=24-alpine3.22
          
          # Labels
          labels: |
            org.opencontainers.image.title=Unthread Discord Bot
            org.opencontainers.image.description=Turn Discord community servers into real-time support ticket hubs â€” powered by Unthread.io
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.url=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.licenses=AGPL-3.0
          
          # Features
          pr-comment-enabled: true
          cache-enabled: true
          provenance: true
          sbom: true

          # Security Scanning
          pre-build-scan-enabled: true
          scan-source-code: true
          scan-dockerfile: true
          image-scan-enabled: true
          trivy-severity: HIGH,CRITICAL
          trivy-ignore-unfixed: false
          upload-sarif: true
